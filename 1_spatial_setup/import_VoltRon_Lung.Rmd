---
title: "import_VoltRon_ILC2s_combined"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output:
  html_document:
    toc: yes
    toc_float: yes
    number_sections: yes
    fig_caption: yes
    keep_md: yes
  pdf_document:
    toc: yes
params:
  Sample: Default
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Libraries

```{r}
if (!requireNamespace("Seurat", quietly = TRUE))
  install.packages("Seurat")
if (!requireNamespace("VoltRon", quietly = TRUE))
  devtools::install_github("Artur-man/VoltRon")
if (!requireNamespace("magick", quietly = TRUE))
  install.packages("magick")
library(Seurat)
library(VoltRon)
library(magick)
library(readr)
library(dplyr)
library(ggplot2)
library(ggpubr)
```

## Change CSV data

Here, we are changing the csv file to include the names of the actual folder with channel images

```{r eval=FALSE, include=FALSE}
datax <- read.csv("data/MELC_data_murine_lung_CTRL_D1_D2_D3.csv")
samples <- datax$FullInfo
samples <- gsub("FOV", "", samples)
samples <- gsub("_D1", "", samples)
samples <- gsub("_D2", "", samples)
samples <- gsub("D3", "lu_d3", samples)
samples <- gsub("CTRL", "lu_ctrl", samples)
datax$Sample <- samples
write.csv(datax, "data/MELC_data_murine_lung_CTRL_D1_D2_D3_withfolders.csv", row.names = FALSE, quote = FALSE)
```

## Import Data

The main loop to go over each FOV and create VoltRon assays

```{r}
# folder path and samples
datax <- read_csv("C:/Users/NieHau/Desktop/Sandy/VoltRon/VoltRon_murine_lung_MELC_data_files/data/MELC_data_murine_lung_CTRL_D1_D2_D3_withfolders.csv")

# Combine ILC2s A and ILC2s B into ILC2s
datax$CellType <- datax$AL3

# rename NK cells/ILC1s to NK cells/ILC1s/ILC3s
# datax$CellType <- gsub("NK cells/ILC1s", "NK cells/ILC1s/ILC3s", datax$CellType)
unique(datax$CellType)

image_folders_path <- "C:/Users/NieHau/Desktop/Sandy/VoltRon/VoltRon_murine_lung_MELC_data_files/images/"
samples <- unique(datax$Sample)
# samples <- samples[!samples %in% "20210906_FOV3_D3"]
# samples <- "20210906_FOV3_D3"

# do this for all samples
vr_list <- NULL
for(samp in samples[-35]){
  # current data fram cur_datax
  cur_datax <- datax[datax$Sample == samp,]
  rownames(cur_datax) <- cur_datax$CellID
  
  # current feature data frame
  cur_data <- cur_datax[,2:34]
  rownames(cur_data) <- cur_datax$CellID

  # sample and image folder
  image_folder <- unique(cur_datax$Sample)
  print(image_folder)

  # metadata
  cur_metadata <- cur_datax[,38:46]
  rownames(cur_metadata) <- cur_datax$CellID

  # coordinates
  cur_coords <- as.matrix(cur_datax[,c("Loc_X", "Loc_Y")])
  rownames(cur_coords) <- cur_datax$CellID

  # make voltron objects
  file_names <- list.files(paste0(image_folders_path, image_folder))
  file_names <- gsub(".png", "", file_names)
  image_names <- file_names
  image_list <- list()
  for(img in image_names){
    try({
      image_list[[img]] <- magick::image_read(paste0(image_folders_path,  image_folder, "/", img, ".png"))
    })
  }
  vr_list[[image_folder]] <- formVoltRon(t(cur_data), metadata = cur_metadata, image = image_list, coords = cur_coords, main.assay = "MELC", sample_name = image_folder)
  
  # flip and resize images
  vr_list[[image_folder]] <- flipCoordinates(vr_list[[image_folder]])
  vr_list[[image_folder]] <- resizeImage(vr_list[[image_folder]], size = 1000)
}
saveRDS(vr_list, file = "C:/Users/NieHau/Desktop/Sandy/VoltRon/VoltRon_murine_lung_MELC_data_files/data/VoltRon_data_lung_ILC2s_combined.rds")
```

## Manipulate VoltRon list

Here, we merge all VoltRon objects into one object

```{r}
vr_list <- readRDS("C:/Users/NieHau/Desktop/Sandy/VoltRon/VoltRon_murine_lung_MELC_data_files/data/VoltRon_data_lung_ILC2s_combined.rds")
vr_merged <- merge(vr_list[[1]], vr_list[-1])
```

Getting a full list of all images available in VoltRon

```{r}
vrImageNames(vr_merged)
```

Getting all FOVs

```{r}
SampleMetadata(vr_merged)
```

## Visualization

Different visualization scripts. If resolution of the figures are low, run it in the console instead of the rmarkdown

```{r, fig.width=9, fig.height=8}
# visualize all FOVs, default image is DAPI
vrSpatialPlot(vr_merged, group.by = "CellType", alpha = 1, ncol = 3)

# with B220 or CD31 as background
vrSpatialPlot(vr_merged, group.by = "CellType", alpha = 0.1, ncol = 3, background = c("image_1", "B220"))
vrSpatialPlot(vr_merged, group.by = "CellType", alpha = 0.1, ncol = 3, background = c("image_1", "CD31"))
vrSpatialPlot(vr_merged, group.by = "CellType", alpha = 0.1, ncol = 3, background = c("image_1", "CD44"))

# visualize first section 
vrSpatialPlot(vr_merged, assay = "Assay1", group.by = "CellType", alpha = 0.1, background = c("image_1", "CD31", ncol = 3))
```

```{r}
save.image("C:/Users/NieHau/Desktop/Sandy/VoltRon/VoltRon_murine_lung_MELC_data_files/data/import_VoltRon_ILC2s_combined_files/environment.Rdata")
```
